import struct
import zlib

def advance(key_bytes):
    # Calculate CRC32 of the key
    crc = zlib.crc32(key_bytes) & 0xffffffff
    
    # Swap bytes of CRC (32-bit swap)
    # 0x12345678 -> 0x78563412
    swapped_crc = struct.unpack("<I", struct.pack(">I", crc))[0]
    
    # Construct new 64-bit key
    # (swapped_crc << 32) | crc
    new_key_val = (swapped_crc << 32) | crc
    
    # Convert to bytes (Little Endian)
    return struct.pack("<Q", new_key_val)

def solve():
    with open("flag.txt.enc", "rb") as f:
        data = f.read()

    if len(data) < 8:
        print("File too short")
        return

    key = data[:8]
    encrypted_data = data[8:]
    
    decrypted_data = bytearray()
    
    # Process in 8-byte chunks
    for i in range(0, len(encrypted_data), 8):
        chunk = encrypted_data[i:i+8]
        
        # Update key
        key = advance(key)
        
        # XOR decrypt byte by byte
        for j, b in enumerate(chunk):
            decrypted_data.append(b ^ key[j])

    with open("flag.txt", "wb") as f:
        f.write(decrypted_data)
    print("Decryption complete.")

if __name__ == "__main__":
    solve()
