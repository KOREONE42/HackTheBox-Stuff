from pwn import *
import string

IP_ADDR = "94.237.58.121"  # Server IP
PORT = 51235               # Server Port

context.log_level = 'error'
s = connect(IP_ADDR, PORT)

def get_encrypted_data(username):
    """
    Connects to the server and retrieves the encrypted hex data for a given username.

    Args:
        username (str): The username to send to the server.

    Returns:
        bytes: The raw bytes of the encrypted response from the server.
    """
    s.sendline(b'1')  # Option to provide username
    s.sendline(username.encode())
    # Read until the hex string is shown
    s.recvuntil(b'encrypted scrolls: ')
    encrypted_hex = s.recvline().strip().decode()
    return bytes.fromhex(encrypted_hex)

def brute_force():
    """
    Attempts to recover the password by brute-forcing one character at a time.
    
    Returns:
        str: The recovered password.
    """
    multiplyer = 47
    password = ""
    charset = string.ascii_letters + string.digits
    while len(password) < 20:
        for char in charset:
            test_username = 'B' * multiplyer
            test_password = password + char
            new_username = test_username + test_password
            decrypt = get_encrypted_data(new_username)


            print(f'[+] Current brute force: {new_username} | Your current password is: {password}')
            decrypt2 = get_encrypted_data(test_username)
            #print(f'Trying {char} for username: {test_username}')
            #if len(password) <= 16:
            if decrypt[28:48] == decrypt2[28:48]:
                password += char
                multiplyer -= 1
                print(f'[+] found a match {char} | current password {password} | current username {new_username}')

    return password

def main():
    """
    Main function that recovers the password, then uses it to retrieve the flag.
    """
    password = brute_force()
    print(f'[+] Password recovered: {password}')

    # Connect and use the password to retrieve the flag
    s.sendline(b'2')
    s.sendline(password.encode())
    s.recvuntil(b'[+] Whisper the sacred incantation to enter the Forbidden Sanctum :: [+] The gates open before you, Keeper of Secrets! ')
    flag = s.recvline().strip().decode()
    print(f'[+] Congratualtions on capturing the flag! {flag}')

if __name__ == "__main__":
    main()
